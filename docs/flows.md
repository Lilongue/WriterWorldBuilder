# Пользовательские сценарии (Flows)

Этот документ описывает несколько ключевых сценариев взаимодействия пользователя с приложением, детализируя действия в UI и соответствующие операции на бэкенде.

---

## Сценарий 1: Создание нового персонажа

1. **Действие пользователя:**
    * В боковой панели навигации нажимает на группу "Персонажи".
    * Нажимает кнопку "Создать нового персонажа".

2. **Реакция интерфейса (UI):**
    * Открывается модальное окно или новая страница с формой для ввода данных.
    * Форма содержит поля, определенные для типа "character" (например, "Имя", "Возраст", "Род деятельности" и основное текстовое поле для описания).
    * Пользователь заполняет поля и нажимает "Сохранить".

3. **Операции бэкенда (Tauri/Rust):**
    * Получает команду от UI с данными нового персонажа.
    * Генерирует уникальное имя для папки (например, на основе имени персонажа: `aragorn`).
    * Создает новую папку по пути, например, `/entities/aragorn/`.
    * Внутри папки создает два файла:
        * `text.md`: с основным описанием персонажа.
        * `meta.yml`: с содержимым вида:

            ```yaml
            type: character
            name: "Арагорн"
            age: 87
            occupation: "Следопыт, Король Гондора"
            ```

4. **Обновление UI:**
    * Новый персонаж "Арагорн" появляется в общем списке персонажей.

---

## Сценарий 2: Изменение порядка эпизодов в главе

1. **Действие пользователя:**
    * Открывает страницу "Глава 1".
    * Видит упорядоченный список эпизодов: `[Эпизод 1, Эпизод 2, Эпизод 3]`.
    * Захватывает мышью "Эпизод 3" и перетаскивает его перед "Эпизодом 2".

2. **Реакция интерфейса (UI):**
    * Список немедленно визуально обновляется, показывая новый порядок: `[Эпизод 1, Эпизод 3, Эпизод 2]`.
    * UI отправляет команду на бэкенд с указанием ID родительской главы и новым порядком ID дочерних эпизодов.

3. **Операции бэкенда (Tauri/Rust):**
    * Получает команду на обновление порядка для "Главы 1".
    * Читает файл `/chapters/chapter-1/meta.yml`.
    * Находит ключ `children` (или аналогичный) и обновляет в нем массив идентификаторов в соответствии с новым порядком.

        ```yaml
        # было: children: [ep1_id, ep2_id, ep3_id]
        # стало: children: [ep1_id, ep3_id, ep2_id]
        ```

    * Перезаписывает файл `meta.yml` с обновленными данными.

---

## Сценарий 3: Создание связи между двумя персонажами

1. **Действие пользователя:**
    * Находится на странице персонажа "Арагорн".
    * Переходит на вкладку "Отношения".
    * Нажимает кнопку "Добавить отношение".

2. **Реакция интерфейса (UI):**
    * Появляется форма, где нужно:
        1. Выбрать другого персонажа из выпадающего списка (например, "Арвен").
        2. Указать тип отношения (например, "Супруга").
        3. Добавить краткое описание.
    * Пользователь заполняет данные и нажимает "Сохранить".

3. **Операции бэкенда (Tauri/Rust):**
    * Получает команду с данными об отношении: `source: aragorn_id`, `target: arwen_id`, `type: 'Spouse'`.
    * Открывает файл `/entities/aragorn/meta.yml`.
    * Добавляет новую запись в список `relationships`:

        ```yaml
        relationships:
          - target: arwen_id
            type: "Spouse"
            description: "..."
        ```

    * Сохраняет измененный файл `meta.yml`.
    * (Опционально) Может выполнить аналогичную операцию для `meta.yml` Арвен, чтобы связь была двусторонней.

4. **Обновление UI:**
    * В списке отношений у Арагорна появляется новая запись: "Арвен (Супруга)".

---

### Сценарий 4: Работа с планом главы

1. **Действие пользователя:**
    * Открывает страницу "Глава 1".
    * Видит несколько вкладок для работы с главой: "Текст", "План", "Метаданные".
    * Нажимает на вкладку "План".

2. **Реакция интерфейса (UI) и операции бэкенда:**
    * UI запрашивает у бэкенда содержимое плана для "Главы 1".
    * Бэкенд проверяет наличие файла `/chapters/chapter-1/plan.md`.
    * **Если файл существует:** Бэкенд читает его и отдает содержимое в UI. UI отображает текст плана в Markdown-редакторе.
    * **Если файл не существует:** Бэкенд сообщает об этом. UI отображает пустой редактор с предложением начать вести план.

3. **Действие пользователя:**
    * Вводит или редактирует текст плана в редакторе. Например: "- Сцена 1: Совет у Элронда. - Сцена 2: Представление Хранителей Кольца."

4. **Сохранение изменений (UI и Бэкенд):**
    * При сохранении (автоматическом или по кнопке) UI отправляет команду на бэкенд с новым текстом плана.
    * Бэкенд получает текст и перезаписывает (или создает) файл `/chapters/chapter-1/plan.md`.
